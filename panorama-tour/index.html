<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>StudioGoboVirtualTour</title>

  <!-- Pannellum (фиксированная версия) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css">
  <script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>

  <style>
    html,body{height:100%;margin:0;background:#000}
    #panorama{width:100%;height:100%}

    /* убираем дефолтную иконку хотспота, но НЕ ломаем наши фоны */
    .pnlm-hotspot{ background:none; }

    /* Кружки */
    .dot{
      width:26px;height:26px;border-radius:50%;
      background:rgba(255,255,255,.5) !important; /* заливка — белая 50% */
      box-sizing:border-box;
    }
    .dot.nav{ border:2px solid #fff; cursor:pointer; } /* переход — с белым контуром */
    .dot.info{ border:none; }

    /* Кастомный тултип на hover (используем data-tip на хотспоте) */
    .dot.info[data-tip]:hover::after{
      content: attr(data-tip);
      position:absolute;
      left:30px; top:0;
      background:rgba(0,0,0,.85);
      color:#fff;
      padding:6px 8px;
      border-radius:6px;
      max-width:260px;
      font:14px/1.3 system-ui,-apple-system,Segoe UI,Roboto,Arial;
      white-space:pre-wrap;
      pointer-events:none;
      transform:translateY(-50%);
      z-index:10000;
    }

    /* Панель языков (справа вверху, можно убрать/переставить) */
    .langbar{
      position:fixed; top:10px; right:10px; z-index:9999;
      display:flex; gap:6px;
    }
    .langbar button{
      padding:6px 10px; border:0; border-radius:8px; cursor:pointer;
      background:rgba(255,255,255,.2); color:#fff;
    }
    .langbar button.active{ background:rgba(255,255,255,.45); color:#000; }

    /* Левый вертикальный «радио»-лист сцен */
    .scene-nav{
      position:fixed; left:10px; top:50%; transform:translateY(-50%);
      z-index:9999; display:flex; flex-direction:column; gap:10px;
    }
    .scene-btn{
      display:flex; align-items:center; gap:10px;
      background:rgba(255,255,255,.3);
      color:#000; border:none; padding:8px 10px;
      cursor:pointer; /* «острые углы» — без бордерадиуса */
    }
    .scene-btn .radio{
      width:16px; height:16px; border:2px solid #000; border-radius:50%;
      display:inline-flex; align-items:center; justify-content:center;
      background:#000; /* чёрный кружок */
    }
    .scene-btn .radio .dot{
      width:8px; height:8px; border-radius:50%;
      background:transparent;
    }
    .scene-btn.active .radio{ background:#000; }
    .scene-btn.active .radio .dot{ background:#fff; } /* активная — белая точка внутри */
  </style>
</head>
<body>
  <div id="panorama"></div>

  <!-- Языки -->
  <div class="langbar">
    <button data-lang="ru" class="active">RU</button>
    <button data-lang="en">EN</button>
    <button data-lang="sr">SR</button>
  </div>

  <!-- Навигация сцен слева -->
  <div class="scene-nav">
    <button class="scene-btn active" data-scene="studio1">
      <span class="radio"><span class="dot"></span></span>
      <span>Studio 1</span>
    </button>
    <button class="scene-btn" data-scene="studio2">
      <span class="radio"><span class="dot"></span></span>
      <span>Studio 2</span>
    </button>
  </div>

  <script>
    // ---------- I18N ----------
    const I18N = {
      ru: {
        paper_bg: "Доп. услуга — бумажные фоны. 500 дин.",
        sl150:    "Постоянный свет SL150 — входит в аренду",
        to_s2:    "Перейти: Studio 2",
        to_s1:    "Перейти: Studio 1"
      },
      en: {
        paper_bg: "Extra service — paper backdrops. 500 RSD.",
        sl150:    "Continuous light SL150 — included",
        to_s2:    "Go to: Studio 2",
        to_s1:    "Go to: Studio 1"
      },
      sr: {
        paper_bg: "Dodatna usluga — papirne pozadine. 500 RSD.",
        sl150:    "Stalno svetlo SL150 — uključeno",
        to_s2:    "Idi na: Studio 2",
        to_s1:    "Idi na: Studio 1"
      }
    };
    let LANG = 'ru';

    // ---------- БАЗОВОЕ ОПИСАНИЕ СЦЕН (файлы + координаты, КАК ТЫ ДАЛ) ----------
    const SCENES_BASE = {
      studio1: {
        pano: "p21fin.jpg?v=1",  // cache-buster
        hotSpots: [
          { id:'to_s2',  type:'scene', yaw: 5.75,   pitch: 0.16,  sceneId:'studio2', kind:'nav' },
          { id:'paper_bg', type:'info', yaw:-83.33, pitch:14.97, kind:'info' },
          { id:'sl150',    type:'info', yaw:-145.18,pitch: 2.35, kind:'info' }
        ]
      },
      studio2: {
        pano: "p22fin.jpg?v=1",
        hotSpots: [
          { id:'to_s1',  type:'scene', yaw:-142.83, pitch: 1.42, sceneId:'studio1', kind:'nav' }
        ]
      }
    };

    // ---------- Pannellum ----------
    var viewer = pannellum.viewer('panorama', {
      "default": { "firstScene": "studio1", "sceneFadeDuration": 400, "autoLoad": true },
      "scenes": buildScenes(LANG)
    });

    // лог для отладки
    viewer.on('load', () => console.log('Pannellum loaded first frame'));
    viewer.on('error', (e) => console.error('Pannellum error:', e));

    // Клик для быстрого снятия координат (в консоль)
    document.getElementById('panorama').addEventListener('click', ()=>{
      console.log('yaw:', viewer.getYaw().toFixed(2), 'pitch:', viewer.getPitch().toFixed(2));
    });

    // ---------- Кастомный «рисователь» кружка ----------
    function makeDot(hotSpotDiv, args){
      // отключаем деф. фон (стрелка), и навешиваем наши классы
      hotSpotDiv.style.background = 'none';
      hotSpotDiv.classList.add('dot', args?.kind === 'nav' ? 'nav' : 'info');

      // для info даём data-tip — наш псевдо-тултип на hover
      if (args?.kind === 'info' && args?.tip) {
        hotSpotDiv.setAttribute('data-tip', args.tip);
      }

      // чтобы было удобно кликать по nav
      if (args?.kind === 'nav') {
        hotSpotDiv.style.cursor = 'pointer';
      }
    }

    // ---------- Генератор сцен под язык ----------
    function buildScenes(lang){
      const common = { type:"equirectangular", autoLoad:true, hfov:100, minHfov:50, maxHfov:120 };
      const scenes = {};

      for (const [key, s] of Object.entries(SCENES_BASE)){
        scenes[key] = { ...common, panorama: s.pano, hotSpots: [] };

        s.hotSpots.forEach(h => {
          if (h.type === 'scene'){
            scenes[key].hotSpots.push({
              pitch: h.pitch, yaw: h.yaw, type:'scene', sceneId: h.sceneId,
              text: I18N[lang][h.id] || '', // текст тултипа у сцены (можно оставить пустым)
              createTooltipFunc: makeDot, createTooltipArgs: { kind:'nav' }
            });
          } else {
            // info с языковым текстом
            scenes[key].hotSpots.push({
              pitch: h.pitch, yaw: h.yaw, type:'info',
              text: I18N[lang][h.id] || '', // не обязателен, но пусть будет
              createTooltipFunc: makeDot, createTooltipArgs: { kind:'info', tip: I18N[lang][h.id] || '' }
            });
          }
        });
      }
      return scenes;
    }

    // ---------- Переключение языков ----------
    document.querySelectorAll('.langbar button').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.langbar button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        LANG = btn.dataset.lang;

        const current = viewer.getScene();
        const yaw = viewer.getYaw(), pitch = viewer.getPitch(), hfov = viewer.getHfov();

        // Пересобираем конфиг под язык и остаёмся в текущей сцене
        viewer.setConfig({ default:{ firstScene: current }, scenes: buildScenes(LANG) });
        viewer.loadScene(current, yaw, pitch, hfov);

        // Обновим подсветку кнопок слева
        updateSceneButtons(current);
      });
    });

    // ---------- Кнопки слева для смены сцен ----------
    function updateSceneButtons(active){
      document.querySelectorAll('.scene-btn').forEach(b=>{
        b.classList.toggle('active', b.dataset.scene === active);
      });
    }
    document.querySelectorAll('.scene-btn').forEach(b=>{
      b.addEventListener('click', ()=>{
        const target = b.dataset.scene;
        const yaw = viewer.getYaw(), pitch = viewer.getPitch(), hfov = viewer.getHfov();
        viewer.loadScene(target, yaw, pitch, hfov);
        updateSceneButtons(target);
      });
    });
    // Инициализируем активную кнопку
    updateSceneButtons('studio1');
  </script>
</body>
</html>
